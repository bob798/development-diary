# 多线程上下文切换

## 前言

并发编程的目的是为了让程序运行得更快，但并不是启动更多的线程就能让程序最大限度地并发执行。

多线程执行任务面临更多的挑战，比如上下文切换的问题、死锁的问题，以及受限于硬件和软件的资源限制问题。

## 什么是上下文切换

cpu通过时间片分配算法来处理多个任务，cpu会将一个任务保存去执行另一个任务。从任务保存到再加载的过程就是一次上下文切换。

## 上下文切换测试代码

为什么并发执行的速度会比串行慢呢？

因为线程的创建和上下文切换存在开销。

## 引起上下文切换的原因

对于经常使用的抢占式操作系统而言，引起上下文切换的原因大概有几种：

- 当前执行任务的时间片用完后，系统CPU正常调度下一个任务
- 当前执行任务碰到IO阻塞，调度器将此任务挂起，继续执行下一任务。
- 多个任务抢占锁资源，当前任务没有抢到锁资源，调度器将此任务挂起，继续执行下一任务。
- 用户代码挂起当前任务，让出CPU时间。
- 硬件中断

## 上下文切换次数查看

## 如何减少上下文切换

- 无锁并发
- CAS算法
- 使用最少线程
- 协程